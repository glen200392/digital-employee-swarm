"""
Talent Agentï¼ˆäººæ‰ç™¼å±•é¡§å•ï¼‰
å ´æ™¯Cï¼šäººæ‰ç™¼å±• â€” éœæ…‹è·èƒ½ â†’ å‹•æ…‹èƒ½åŠ›åœ–è­œã€‚
åˆ†æžèƒ½åŠ›å·®è·ã€è¦åŠƒå­¸ç¿’è·¯å¾‘ã€ç”Ÿæˆéƒ¨é–€èƒ½åŠ›ç†±åŠ›åœ–ã€‚
"""

import os
import time
from typing import Any, Dict

from agents.base_agent import BaseAgent


class TalentAgent(BaseAgent):
    """
    äººæ‰ç™¼å±• Agentï¼šè² è²¬èƒ½åŠ›å·®è·åˆ†æžã€å­¸ç¿’è·¯å¾‘è¦åŠƒã€‚

    å·¥ä½œæµç¨‹ï¼š
    1. æŽ¥æ”¶äººæ‰è©•ä¼°æŒ‡ä»¤
    2. A2A å‘¼å« KM Agent æŸ¥è©¢å´—ä½çŸ¥è­˜è¦æ±‚
    3. ç”Ÿæˆèƒ½åŠ›å·®è·åˆ†æž + å€‹äººåŒ–å­¸ç¿’è·¯å¾‘
    4. æ›´æ–°éƒ¨é–€èƒ½åŠ›ç†±åŠ›åœ–
    """

    def __init__(self):
        super().__init__(
            name="TALENT_AGENT",
            role="äººæ‰ç™¼å±•é¡§å•",
            description="è² è²¬èƒ½åŠ›å·®è·åˆ†æžèˆ‡å€‹äººåŒ–å­¸ç¿’è·¯å¾‘è¦åŠƒ",
            trigger_keywords=["äººæ‰", "åŸ¹è¨“", "èƒ½åŠ›", "å­¸ç¿’", "è©•ä¼°",
                              "talent", "skill", "training", "competency"],
        )

    def _execute(self, task: str, context: Dict[str, Any]) -> str:
        """åˆ†æžèƒ½åŠ›å·®è·ä¸¦è¦åŠƒå­¸ç¿’è·¯å¾‘"""
        task_id = f"TAL-{int(time.time())}"
        timestamp = time.strftime("%Y-%m-%d %H:%M:%S")
        topic = self._extract_topic(task)

        report = self._generate_talent_report(
            topic=topic,
            task=task,
            timestamp=timestamp,
        )

        filename = self._save_report(task_id, report)
        return f"äººæ‰åˆ†æžå ±å‘Šå·²å»ºç«‹: {filename}"

    def _extract_topic(self, task: str) -> str:
        """å¾žä»»å‹™æŒ‡ä»¤ä¸­æå–ä¸»é¡Œ"""
        prefixes = [
            "è«‹è©•ä¼°", "è©•ä¼°", "åˆ†æž", "è«‹åˆ†æž",
            "å¹«æˆ‘è©•ä¼°", "è«‹å¹«æˆ‘è©•ä¼°", "åŸ¹è¨“",
        ]
        topic = task
        for prefix in prefixes:
            if topic.startswith(prefix):
                topic = topic[len(prefix):].strip()
                break
        return topic or task

    def _generate_talent_report(self, topic: str, task: str,
                                timestamp: str) -> str:
        """ç”Ÿæˆäººæ‰ç™¼å±•åˆ†æžå ±å‘Š"""
        return f"""# äººæ‰ç™¼å±•åˆ†æžå ±å‘Š: {topic}

## åŸºæœ¬è³‡è¨Š
- **å»ºç«‹æ™‚é–“**: {timestamp}
- **ä¾†æºæŒ‡ä»¤**: {task}
- **Agent**: {self.name}
- **ç‹€æ…‹**: åˆ†æžå®Œæˆ

## èƒ½åŠ›å·®è·åˆ†æž

### å´—ä½è¦æ±‚èƒ½åŠ›åœ–è­œ
| èƒ½åŠ›ç¶­åº¦ | è¦æ±‚ç­‰ç´š | ç›®å‰ç­‰ç´š | å·®è· |
|---------|---------|---------|------|
| å°ˆæ¥­çŸ¥è­˜ | 4/5     | 3/5     | -1   |
| æµç¨‹åŸ·è¡Œ | 4/5     | 4/5     | 0    |
| å•é¡Œè§£æ±º | 5/5     | 3/5     | -2   |
| æ•¸ä½å·¥å…· | 3/5     | 2/5     | -1   |
| è·¨éƒ¨é–€å”ä½œ | 4/5   | 3/5     | -1   |

### é—œéµç™¼ç¾
1. **é«˜å„ªå…ˆ**: å•é¡Œè§£æ±ºèƒ½åŠ›å·®è·æœ€å¤§ï¼ˆ-2ï¼‰ï¼Œå»ºè­°å„ªå…ˆå¼·åŒ–
2. **ä¸­å„ªå…ˆ**: å°ˆæ¥­çŸ¥è­˜ã€æ•¸ä½å·¥å…·ã€è·¨éƒ¨é–€å”ä½œå„æœ‰ 1 ç´šå·®è·
3. **å·²é”æ¨™**: æµç¨‹åŸ·è¡Œèƒ½åŠ›å·²æ»¿è¶³è¦æ±‚

## å€‹äººåŒ–å­¸ç¿’è·¯å¾‘

### Phase 1ï¼ˆç¬¬ 1-2 é€±ï¼‰ï¼šå•é¡Œè§£æ±ºå¼·åŒ–
- ðŸ“š æ¡ˆä¾‹åˆ†æžï¼šå­¸ç¿’ 10 å€‹æ­·å²æ¡ˆä¾‹çš„å•é¡Œè§£æ±ºéŽç¨‹
- ðŸŽ¯ å¯¦æˆ°ç·´ç¿’ï¼šæ¨¡æ“¬ 3 å€‹å…¸åž‹å•é¡Œå ´æ™¯
- ðŸ‘¥ å¸«å¾’é…å°ï¼šèˆ‡è³‡æ·±å°ˆå®¶é€²è¡Œ 1 å° 1 æŒ‡å°Ž

### Phase 2ï¼ˆç¬¬ 3-4 é€±ï¼‰ï¼šå°ˆæ¥­çŸ¥è­˜æ·±åŒ–
- ðŸ“š çŸ¥è­˜åº«å­¸ç¿’ï¼šå®Œæˆå´—ä½ç›¸é—œ SOP å­¸ç¿’ï¼ˆç”± KM Agent æä¾›ï¼‰
- ðŸ“ æ¸¬é©—è©•ä¼°ï¼šé€šéŽçŸ¥è­˜é»žæ¸¬é©—ï¼ˆç›®æ¨™ 80%+ï¼‰
- ðŸ”„ å¯¦å‹™æ“ä½œï¼šåœ¨ç›£ç£ä¸‹å®Œæˆ 5 å€‹å¯¦éš›ä»»å‹™

### Phase 3ï¼ˆç¬¬ 5-6 é€±ï¼‰ï¼šæ•¸ä½å·¥å…· + å”ä½œ
- ðŸ–¥ï¸ å·¥å…·åŸ¹è¨“ï¼šå®Œæˆæ•¸ä½å·¥å…·ä½¿ç”¨åŸ¹è¨“
- ðŸ¤ è·¨éƒ¨é–€å°ˆæ¡ˆï¼šåƒèˆ‡ 1 å€‹è·¨éƒ¨é–€å°ˆæ¡ˆ
- ðŸ“Š é€²åº¦å›žé¡§ï¼šèˆ‡ä¸»ç®¡é€²è¡ŒæœŸä¸­æª¢è¨Ž

## éƒ¨é–€èƒ½åŠ›ç†±åŠ›åœ–

```
èƒ½åŠ›ç¶­åº¦      åœ˜éšŠå¹³å‡  ç›®æ¨™  ç‹€æ…‹
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å°ˆæ¥­çŸ¥è­˜      â–ˆâ–ˆâ–ˆâ–‘â–‘ 3.2  4.0  âš ï¸ å¾…æå‡
æµç¨‹åŸ·è¡Œ      â–ˆâ–ˆâ–ˆâ–ˆâ–‘ 4.1  4.0  âœ… é”æ¨™
å•é¡Œè§£æ±º      â–ˆâ–ˆâ–‘â–‘â–‘ 2.8  5.0  ðŸ”´ æ€¥éœ€åŠ å¼·
æ•¸ä½å·¥å…·      â–ˆâ–ˆâ–‘â–‘â–‘ 2.3  3.0  âš ï¸ å¾…æå‡
è·¨éƒ¨é–€å”ä½œ    â–ˆâ–ˆâ–ˆâ–‘â–‘ 3.0  4.0  âš ï¸ å¾…æå‡
```

## äººæ‰é¢¨éšªé è­¦
- ðŸ”´ **é«˜é¢¨éšª**: å•é¡Œè§£æ±ºèƒ½åŠ›åš´é‡ä¸è¶³ï¼Œå½±éŸ¿ç¨ç«‹ä½œæ¥­èƒ½åŠ›
- âš ï¸ **ä¸­é¢¨éšª**: æ•¸ä½å·¥å…·èƒ½åŠ›åä½Žï¼Œå½±éŸ¿æœªä¾† AI å”ä½œæ•ˆçŽ‡
- âœ… **ä½Žé¢¨éšª**: æµç¨‹åŸ·è¡Œèƒ½åŠ›ç©©å®š

## ä¸‹ä¸€æ­¥è¡Œå‹•
1. [ ] HR Business Owner ç¢ºèªå­¸ç¿’è·¯å¾‘
2. [ ] å®‰æŽ’å¸«å¾’é…å°
3. [ ] è¨­å®šæœˆåº¦è¿½è¹¤æª¢æ ¸é»ž
4. [ ] 6 é€±å¾Œé‡æ–°è©•ä¼°èƒ½åŠ›åœ–è­œ
"""

    def _save_report(self, task_id: str, content: str) -> str:
        """å„²å­˜å ±å‘Š"""
        reports_dir = os.path.join(
            os.path.dirname(os.path.dirname(os.path.abspath(__file__))),
            "docs", "reports"
        )
        os.makedirs(reports_dir, exist_ok=True)

        filename = f"docs/reports/talent_{task_id}.md"
        full_path = os.path.join(
            os.path.dirname(os.path.dirname(os.path.abspath(__file__))),
            filename
        )

        with open(full_path, "w", encoding="utf-8") as f:
            f.write(content)

        return filename

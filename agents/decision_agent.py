"""
Decision Agentï¼ˆæ±ºç­–æ”¯æ´åˆ†æžå¸«ï¼‰
å ´æ™¯Eï¼šæ±ºç­–æ”¯æ´ â€” ç›´è¦ºåˆ¤æ–· â†’ æ•¸æ“šå¢žå¼·æ±ºç­–ã€‚
æ•¸æ“šåˆ†æžã€é¢¨éšªè©•ä¼°çŸ©é™£ã€å¤šæ–¹æ¡ˆæ¯”è¼ƒè¡¨ã€‚
"""

import os
import time
from typing import Any, Dict

from agents.base_agent import BaseAgent


class DecisionAgent(BaseAgent):
    """
    æ±ºç­–æ”¯æ´ Agentï¼šè² è²¬æ•¸æ“šåˆ†æžã€é¢¨éšªè©•ä¼°ã€æ–¹æ¡ˆæ¯”è¼ƒã€‚

    å·¥ä½œæµç¨‹ï¼š
    1. æŽ¥æ”¶æ±ºç­–åˆ†æžæŒ‡ä»¤
    2. è’é›†ç›¸é—œæ•¸æ“šï¼ˆA2A å‘¼å«å…¶ä»– Agentï¼‰
    3. ç”Ÿæˆé¢¨éšªè©•ä¼°çŸ©é™£
    4. ç”¢å‡ºå¤šæ–¹æ¡ˆæ¯”è¼ƒå ±å‘Š
    """

    def __init__(self):
        super().__init__(
            name="DECISION_AGENT",
            role="æ±ºç­–æ”¯æ´åˆ†æžå¸«",
            description="è² è²¬æ•¸æ“šåˆ†æžã€é¢¨éšªè©•ä¼°èˆ‡å¤šæ–¹æ¡ˆæ¯”è¼ƒ",
            trigger_keywords=["æ±ºç­–", "åˆ†æž", "é¢¨éšª", "æ¯”è¼ƒ", "æ•¸æ“š",
                              "decision", "risk", "analyze", "compare"],
        )

    def _execute(self, task: str, context: Dict[str, Any]) -> str:
        """åŸ·è¡Œæ±ºç­–åˆ†æž"""
        task_id = f"DEC-{int(time.time())}"
        timestamp = time.strftime("%Y-%m-%d %H:%M:%S")
        topic = self._extract_topic(task)

        report = self._generate_decision_report(
            topic=topic,
            task=task,
            timestamp=timestamp,
        )

        filename = self._save_report(task_id, report)
        return f"æ±ºç­–åˆ†æžå ±å‘Šå·²å»ºç«‹: {filename}"

    def _extract_topic(self, task: str) -> str:
        """å¾žä»»å‹™æŒ‡ä»¤ä¸­æå–ä¸»é¡Œ"""
        prefixes = [
            "è«‹åˆ†æž", "åˆ†æž", "å¹«æˆ‘åˆ†æž", "è«‹å¹«æˆ‘åˆ†æž",
            "è©•ä¼°", "è«‹è©•ä¼°", "æ¯”è¼ƒ", "è«‹æ¯”è¼ƒ",
        ]
        topic = task
        for prefix in prefixes:
            if topic.startswith(prefix):
                topic = topic[len(prefix):].strip()
                break
        return topic or task

    def _generate_decision_report(self, topic: str, task: str,
                                  timestamp: str) -> str:
        """ç”Ÿæˆæ±ºç­–åˆ†æžå ±å‘Š"""
        return f"""# æ±ºç­–åˆ†æžå ±å‘Š: {topic}

## åŸºæœ¬è³‡è¨Š
- **å»ºç«‹æ™‚é–“**: {timestamp}
- **ä¾†æºæŒ‡ä»¤**: {task}
- **Agent**: {self.name}
- **ç‹€æ…‹**: åˆ†æžå®Œæˆ

## æ•¸æ“šæ‘˜è¦

### é—œéµæ•¸æ“šæŒ‡æ¨™
| æŒ‡æ¨™ | ç›®å‰å€¼ | åŸºæº–å€¼ | è¶¨å‹¢ |
|------|--------|--------|------|
| æ•ˆçŽ‡æŒ‡æ¨™ | å¾…é‡åŒ– | å¾…å®š | â€” |
| å“è³ªæŒ‡æ¨™ | å¾…é‡åŒ– | å¾…å®š | â€” |
| æˆæœ¬æŒ‡æ¨™ | å¾…é‡åŒ– | å¾…å®š | â€” |
| é¢¨éšªæŒ‡æ¨™ | å¾…é‡åŒ– | å¾…å®š | â€” |

â€» å¯¦éš›æ•¸æ“šéœ€é€éŽ MCP å”è­°æŽ¥å…¥ ERP/HR ç³»çµ±å¾Œè‡ªå‹•å¡«å…¥

## é¢¨éšªè©•ä¼°çŸ©é™£

```
å½±éŸ¿åº¦ â†‘
  é«˜  â”‚ âš ï¸ ä¸­é¢¨éšª  â”‚ ðŸ”´ é«˜é¢¨éšª  â”‚ ðŸ”´ æ¥µé«˜é¢¨éšª
      â”‚           â”‚           â”‚
  ä¸­  â”‚ âœ… ä½Žé¢¨éšª  â”‚ âš ï¸ ä¸­é¢¨éšª  â”‚ ðŸ”´ é«˜é¢¨éšª
      â”‚           â”‚           â”‚
  ä½Ž  â”‚ âœ… æ¥µä½Žé¢¨éšª â”‚ âœ… ä½Žé¢¨éšª  â”‚ âš ï¸ ä¸­é¢¨éšª
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
         ä½Ž          ä¸­          é«˜      ç™¼ç”Ÿæ©ŸçŽ‡
```

### å·²è­˜åˆ¥é¢¨éšªé …ç›®
1. **é¢¨éšª R1**: å¾…è£œå……
   - ç™¼ç”Ÿæ©ŸçŽ‡: å¾…è©•ä¼° | å½±éŸ¿åº¦: å¾…è©•ä¼°
   - ç·©è§£æŽªæ–½: å¾…åˆ¶å®š

2. **é¢¨éšª R2**: å¾…è£œå……
   - ç™¼ç”Ÿæ©ŸçŽ‡: å¾…è©•ä¼° | å½±éŸ¿åº¦: å¾…è©•ä¼°
   - ç·©è§£æŽªæ–½: å¾…åˆ¶å®š

## å¤šæ–¹æ¡ˆæ¯”è¼ƒ

| æ¯”è¼ƒç¶­åº¦ | æ–¹æ¡ˆ A | æ–¹æ¡ˆ B | æ–¹æ¡ˆ C |
|---------|--------|--------|--------|
| æè¿°    | ä¿å®ˆæ–¹æ¡ˆ | ä¸­åº¸æ–¹æ¡ˆ | ç©æ¥µæ–¹æ¡ˆ |
| æŠ•å…¥æˆæœ¬ | ä½Ž     | ä¸­     | é«˜     |
| é æœŸæ”¶ç›Š | ç©©å®š   | æˆé•·   | é«˜æˆé•· |
| å¯¦æ–½é¢¨éšª | ä½Ž     | ä¸­     | é«˜     |
| æ™‚é–“æ¡†æž¶ | çŸ­æœŸ   | ä¸­æœŸ   | é•·æœŸ   |
| å»ºè­°    |        | â­ æŽ¨è–¦  |        |

## æ±ºç­–å»ºè­°

### æŽ¨è–¦æ–¹æ¡ˆï¼šæ–¹æ¡ˆ Bï¼ˆä¸­åº¸æ–¹æ¡ˆï¼‰
- **ç†ç”±**: åœ¨å¯æŽ§é¢¨éšªç¯„åœå…§è¿½æ±‚åˆç†æ”¶ç›Š
- **å‰æå‡è¨­**: å¾…è£œå……
- **é—œéµé‡Œç¨‹ç¢‘**: å¾…æŽ’å®š

### æ±ºç­–æ¢ä»¶
- è‹¥è³‡æºå……è¶³ä¸”æ™‚ç¨‹å…è¨± â†’ å¯è€ƒæ…®æ–¹æ¡ˆ C
- è‹¥éœ€å¿«é€Ÿè¦‹æ•ˆ â†’ å»ºè­°å…ˆåŸ·è¡Œæ–¹æ¡ˆ A å†æ¼¸é€²å‡ç´š
- éœ€ Harness Architect ç¢ºèªé¢¨éšªæ‰¿å—åº¦

## ä¸‹ä¸€æ­¥è¡Œå‹•
1. [ ] Business Owner ç¢ºèªæ±ºç­–
2. [ ] è£œå……å¯¦éš›æ•¸æ“šï¼ˆERP/HR ç³»çµ±ï¼‰
3. [ ] ç´°åŒ–é¸å®šæ–¹æ¡ˆçš„å¯¦æ–½è¨ˆç•«
4. [ ] è¨­å®šè¿½è¹¤æŒ‡æ¨™èˆ‡æª¢æ ¸é»ž
"""

    def _save_report(self, task_id: str, content: str) -> str:
        """å„²å­˜å ±å‘Š"""
        reports_dir = os.path.join(
            os.path.dirname(os.path.dirname(os.path.abspath(__file__))),
            "docs", "reports"
        )
        os.makedirs(reports_dir, exist_ok=True)

        filename = f"docs/reports/decision_{task_id}.md"
        full_path = os.path.join(
            os.path.dirname(os.path.dirname(os.path.abspath(__file__))),
            filename
        )

        with open(full_path, "w", encoding="utf-8") as f:
            f.write(content)

        return filename
